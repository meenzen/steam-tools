@using Meenzen.SteamTools.Services
@using Meenzen.SteamTools.Models
@using System.Text.Json
@using Meenzen.SteamTools.Components.Extensions
@using Meenzen.SteamTools.Generated
@inject SteamApi Api
@inject ISnackbar Snackbar
@inject ILogger<PlayTimeCalculator> Logger

<MudText Typo="Typo.h2" Class="mt-4" GutterBottom="true" Align="Align.Center">Playtime per Platform</MudText>

@if (_result is null)
{
    <MudText Align="Align.Center">
        <LoadingButton OnClick="@Load" Loading="@_loading" Text="Calculate"/>
    </MudText>
}

@if (_result is not null)
{
    <MudAlert Severity="Severity.Info" Class="mt-4 mb-2">Owned Games: @_result.GameCount</MudAlert>
    <MudSimpleTable>
        <tbody>
        <tr>
            <td>Total Playtime</td>
            <td>@TotalPlaytime.TotalMinutes minutes</td>
            <td>@TotalPlaytime.TotalHours.ToReadable() hours</td>
        </tr>
        <tr>
            <td>Last 2 weeks</td>
            <td>@TotalPlaytimeLast2Weeks.TotalMinutes minutes</td>
            <td>@TotalPlaytimeLast2Weeks.TotalHours.ToReadable() hours</td>
        </tr>
        <tr>
            <td>Windows Playtime</td>
            <td>@WindowsPlaytime.TotalMinutes minutes</td>
            <td>@WindowsPlaytime.TotalHours.ToReadable() hours</td>
        </tr>
        <tr>
            <td>Linux Playtime</td>
            <td>@LinuxPlaytime.TotalMinutes minutes</td>
            <td>@LinuxPlaytime.TotalHours.ToReadable() hours</td>
        </tr>
        <tr>
            <td>Mac Playtime</td>
            <td>@MacPlaytime.TotalMinutes minutes</td>
            <td>@MacPlaytime.TotalHours.ToReadable() hours</td>
        </tr>
        <tr>
            <td>Playtime Disconnected</td>
            <td>@PlaytimeDisconnected.TotalMinutes minutes</td>
            <td>@PlaytimeDisconnected.TotalHours.ToReadable() hours</td>
        </tr>
        </tbody>
    </MudSimpleTable>
}

@code
{
    private OwnedGamesResponse? _result = null;
    private bool _loading = false;

    private TimeSpan TotalPlaytime { get; set; } = TimeSpan.Zero;
    private TimeSpan TotalPlaytimeLast2Weeks { get; set; } = TimeSpan.Zero;
    private TimeSpan WindowsPlaytime { get; set; } = TimeSpan.Zero;
    private TimeSpan LinuxPlaytime { get; set; } = TimeSpan.Zero;
    private TimeSpan MacPlaytime { get; set; } = TimeSpan.Zero;
    private TimeSpan PlaytimeDisconnected { get; set; } = TimeSpan.Zero;

    private async Task Load()
    {
        if (_loading)
        {
            return;
        }

        _loading = true;

        try
        {
            SteamResponse<OwnedGamesResponse>? response = await Api.GetOwnedGamesAsync();
            await Task.Run(() => Calculate(response));
        }
        catch (Exception e)
        {
            Snackbar.Add("Error loading owned games", Severity.Error);
            Logger.LogError(e, "Error loading owned games");
        }

        _loading = false;
    }

    private void Calculate(SteamResponse<OwnedGamesResponse>? response)
    {
        _result = response?.Response;

        if (_result is null)
        {
            return;
        }

        long totalPlaytime = 0;
        long totalPlaytimeLast2Weeks = 0;
        long windowsPlaytime = 0;
        long linuxPlaytime = 0;
        long macPlaytime = 0;
        long playtimeDisconnected = 0;

        foreach (var game in _result.Games)
        {
            totalPlaytime += game.PlaytimeForever;
            if (game.Playtime2Weeks is not null)
            {
                totalPlaytimeLast2Weeks += game.Playtime2Weeks.Value;
            }
            windowsPlaytime += game.PlaytimeWindowsForever;
            linuxPlaytime += game.PlaytimeLinuxForever;
            macPlaytime += game.PlaytimeMacForever;
            playtimeDisconnected += game.PlaytimeDisconnected;
        }

        TotalPlaytime = TimeSpan.FromMinutes(totalPlaytime);
        TotalPlaytimeLast2Weeks = TimeSpan.FromMinutes(totalPlaytimeLast2Weeks);
        WindowsPlaytime = TimeSpan.FromMinutes(windowsPlaytime);
        LinuxPlaytime = TimeSpan.FromMinutes(linuxPlaytime);
        MacPlaytime = TimeSpan.FromMinutes(macPlaytime);
        PlaytimeDisconnected = TimeSpan.FromMinutes(playtimeDisconnected);
    }
}